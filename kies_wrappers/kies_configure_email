#!/bin/bash
#Released under GNU General Public License version 3, see the file COPYING for details.
check_for() {
if (which "$1" 2> /dev/null > /dev/null)
  then ok=0
  else ok=1
  fi
}
if (test $# -eq 0)
 then echo "This script can break an existing email configuration."
  echo "It should only be used on Debian-based systems running exim"
  read -p "type the word yes to continue, just press enter to aboart. " wag
  if (test "$wag" != "yes")
    then exit 1
    fi
    else
     if (test "$1" != "-w")
       then echo "invalid parameter."
       echo "usage: $0 [-w] suppress warnings"
       exit 1
     fi
     
    fi
    
check_for alpine
if (test $ok -eq 1)
 then check_for pine
   if (test $ok -eq 1)
     then echo "$0 requires alpine or pine neither of which is installed"
     read -t8 -p"press enter to exit." wag
     exit 1
   fi
 fi
check_for fetchmail
if (test $ok -eq 1)
 then echo "$0 requires fetchmail  which is not  installed"
 read -t8 -p"press enter to exit" wag
 exit 1
fi
test -e /usr/sbin/exim&&ok=0||ok=1
if (test $ok -eq 1)
 then echo "$0 requires exim which is not installed"
 read -t8 -p "press enter to exit" wag
 exit 1
fi
test -e /usr/sbin/update-exim4.conf&&ok=0||ok=1

if (test $ok -eq 1)
 then echo "$0 requires update-exim4.conf which is not installed"
 read -t8 -p "press enter to exit" wag
 exit 1
fi

export PATH=$PATH:/sbin
settings="$HOME/.kies/.kies_email_settings"
if test -e "$settings"
 then smtpname=`sed -n 1p $settings`
  smtp_ssl=`sed -n 2p $settings`
 pop3name=`sed -n 3p $settings`
 pop3_ssl=`sed -n 4p $settings`
 pop3login=`sed -n 5p $settings`
 pop3password=`sed -n 6p $settings`
 email=`sed -n 7p $settings`
 fullname=`sed -n 8p $settings`
fi

#get input from user 
read -e -p "what is the name of the outgoing mail (smtp) server? " -i "$smtpname" smtpname
read -e -p"use SSL when sending out email? y/n  If unsure, press enter for no. " -i "$smtp_ssl" smtp_ssl
read -e -p "what is the name of the pop3 server (incoming mail server)? " -i "$pop3name" pop3name
read -e -p"Use SSL when fetching mail y/n? If unsure, press enter for no. " -i "$pop3_ssl" pop3_ssl
read -e -p "what is your pop3 username? " -i "$pop3login" pop3login
read -e -p "What is your password? " -i "$pop3password" pop3password
test "$email" = ""&&email=$pop3login
read -e -p "what is your email address? " -i "$email" email
read -e -p "what is your full name? " -i "$fullname" fullname
#write away settings
echo "$smtpname" > "$settings"
echo "$smtp_ssl" >> "$settings"
echo "$pop3name" >> "$settings"
echo "$pop3_ssl" >> "$settings"
echo "$pop3login" >> "$settings"
echo "$pop3password" >> "$settings"
echo "$email" >> "$settings"
echo "$fullname" >> "$settings"
#next line sets $realhost to the real hostname of $smtpname
realhost=`host $smtpname|grep "alias for"`&&realhost=`echo "$realhost"|rev|cut -f1 -d' '|cut -c2- |rev`||realhost=$smtpname
test "$smtp_ssl" = "y"&&smtpname="$smtpname"::587
domain=`echo $email|cut -f2 -d'@'`
let realhost_num_ips=`host $realhost |grep 'has address'|wc -l`||read -p"error likely due to lack of internet connectivity. Press enter." wag

#do the next stuff as root
sudo su << eot
echo $domain > /etc/mailname&&\
cat /opt/kies/share/kies/kies_wrappers/configure_email.templates/update-exim4.conf.conf.notetaker \
|sed s/outgoing.mail.server/$smtpname/g > /etc/exim4/update-exim4.conf.conf
echo "#This file was automatically generated by kies_configure_email" > /etc/exim4/passwd.client
for i in {1..$realhost_num_ips};do
 echo "$realhost":"$pop3login":"$pop3password" >> /etc/exim4/passwd.client
done&&\

 /usr/sbin/update-exim4.conf 2> /dev/null&&\
/etc/init.d/exim4 reload 2> /dev/null
echo "Checking if there is mail to be sent"
exim -qff
eot
#edit .pinerc
test -e $HOME/.pinerc&&chmod 700 $HOME/.pinerc
cat /opt/kies/share/kies/kies_wrappers/configure_email.templates/.pinerc.notetaker|\
sed s/user-domain=notetaker.domain/user-domain="$domain"/\;\
s/notetakerfullname\<notetaker@notetaker.domain\>/"$fullname"\<"$email"\>/\;\
s/notetaker@notetaker.domain/"$email"/\
 > $HOME/.pinerc
chmod 600 .pinerc
#edit $HOME/.FETCHMAILRC
test -e $HOME/.fetchmailrc&&chmod  700 $HOME/.fetchmailrc

echo "poll $pop3name" > "$HOME"/.fetchmailrc
echo "proto pop3" >> "$HOME"/.fetchmailrc
echo "username $pop3login" >> "$HOME"/.fetchmailrc
echo "password $pop3password" >> "$HOME"/.fetchmailrc
test "$pop3_ssl" = "y"&&echo "ssl" >> "$HOME"/.fetchmailrc

chmod 600 $HOME/.fetchmailrc

